function e(){return indexedDB.open("MeeExtensionDB",7)}async function t(t){const n=new Promise(((n,a)=>{const s=e();s.onerror=e=>{a()},s.onsuccess=function(e){let s=e.target.result;const o=s.transaction(["domains"],"readwrite").objectStore("domains").get(t);o.onerror=e=>{a()},o.onsuccess=e=>{n(e.target.result)},s.close()}}));return await n.then((e=>e))}async function n(e,t){let n={addRules:[{id:e,priority:2,action:{type:"modifyHeaders",requestHeaders:[{header:"Sec-GPC",operation:"remove"},{header:"DNT",operation:"remove"}]},condition:{urlFilter:t,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","webtransport","webbundle","other"]}}],removeRuleIds:[e]};await chrome.declarativeNetRequest.updateDynamicRules(n)}async function a(){let e=chrome.declarativeNetRequest.MAX_NUMBER_OF_DYNAMIC_AND_SESSION_RULES,t={removeRuleIds:[...Array(e).keys()]};await chrome.declarativeNetRequest.updateDynamicRules(t)}async function s(){let t=1;const a=await async function(){const t=new Promise(((t,n)=>{const a=[],s=e();s.onerror=e=>{n()},s.onsuccess=function(e){let n=e.target.result;n.transaction(["domains"],"readwrite").objectStore("domains").openCursor().onsuccess=e=>{const n=e.target.result;n?(!1===n.value.enabled&&a.push(n.value.domain),n.continue()):t(a)},n.close()}}));return await t.then((e=>e))}();if(a){let e=[];for(let s of a)await n(t++,s),e.push(`*://${s}/*`);chrome.scripting.updateContentScripts([{id:"1",matches:["<all_urls>"],excludeMatches:e,js:["gpc-scripts/add-gpc-dom.js"],runAt:"document_start"}])}}function o(t,n){let a=n.tab.id,s=new URL(n.origin).hostname.replace("www.",""),o=[];o[a]=t.data;let c=t.data;const r=!(!o[a]||!0!==o[a].gpc);!0===r&&chrome.action.setIcon({tabId:a,path:"images/icon-96.png"}),async function(t){e().onsuccess=function(e){var n=e.target.result.transaction(["domains"],"readwrite").objectStore("domains");n.get(t.domain).onsuccess=e=>{const a=e.target.result,s=a&&!a.enabled?{domain:t.domain,wellknown:t.gpc,enabled:!1}:t,o=n.put(s);o.onerror=e=>{console.warn("requestUpdate error",e)},o.onsuccess=e=>{console.log("requestUpdate onsuccess",e)}}}}({domain:s,wellknown:r,enabled:!0}),chrome.runtime.onMessage.addListener((function(e,t,n){"POPUP_LOADED"===e.msg&&chrome.runtime.sendMessage({msg:"SEND_WELLKNOWN_TO_POPUP",data:{domain:s,wellknownData:c}})}))}!async function(){e().onupgradeneeded=function(e){const t=e.target.result,n=t.createObjectStore("domains",{keyPath:"domain"});n.createIndex("wellknown","wellknown",{unique:!1}),n.createIndex("enabled","enabled",{unique:!1}),n.createIndex("domain","enabled",{unique:!0}),t.close()}}(),chrome.runtime.onMessage.addListener((async function(e,c,r){switch(e.msg){case"DOWNLOAD_WELLKNOWN":o(e,c);break;case"UPDATE_SELECTOR":await a(),await s();break;case"UPDATE_ENABLED":await async function(){await a();const e=await t("meeExtension");!e||e.enabled?await s():(chrome.scripting.updateContentScripts([{id:"1",matches:["https://example.com/"],excludeMatches:[],js:["gpc-scripts/add-gpc-dom.js"],runAt:"document_start"}]),await n(1,"*"))}()}return!0})),chrome.runtime.onInstalled.addListener((async function(e){await chrome.scripting.registerContentScripts([{id:"1",matches:["<all_urls>"],excludeMatches:[],js:["gpc-scripts/add-gpc-dom.js"],runAt:"document_start"}]);const a=await t("meeExtension");!a||a.enabled?await s():(chrome.scripting.updateContentScripts([{id:"1",matches:["https://example.com/"],excludeMatches:[],js:["gpc-scripts/add-gpc-dom.js"],runAt:"document_start"}]),await n(1,"*"))}));
